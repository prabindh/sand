CanvasMatrix4=function(a){if(typeof a=="object"){if("length" in a&&a.length>=16){this.load(a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8],a[9],a[10],a[11],a[12],a[13],a[14],a[15]);return}else{if(a instanceof CanvasMatrix4){this.load(a);return}}}this.makeIdentity()};CanvasMatrix4.prototype.load=function(){if(arguments.length==1&&typeof arguments[0]=="object"){var a=arguments[0];if("length" in a&&a.length==16){this.m11=a[0];this.m12=a[1];this.m13=a[2];this.m14=a[3];this.m21=a[4];this.m22=a[5];this.m23=a[6];this.m24=a[7];this.m31=a[8];this.m32=a[9];this.m33=a[10];this.m34=a[11];this.m41=a[12];this.m42=a[13];this.m43=a[14];this.m44=a[15];return}if(arguments[0] instanceof CanvasMatrix4){this.m11=a.m11;this.m12=a.m12;this.m13=a.m13;this.m14=a.m14;this.m21=a.m21;this.m22=a.m22;this.m23=a.m23;this.m24=a.m24;this.m31=a.m31;this.m32=a.m32;this.m33=a.m33;this.m34=a.m34;this.m41=a.m41;this.m42=a.m42;this.m43=a.m43;this.m44=a.m44;return}}this.makeIdentity()};CanvasMatrix4.prototype.getAsArray=function(){return[this.m11,this.m12,this.m13,this.m14,this.m21,this.m22,this.m23,this.m24,this.m31,this.m32,this.m33,this.m34,this.m41,this.m42,this.m43,this.m44]};CanvasMatrix4.prototype.getAsWebGLFloatArray=function(){return new WebGLFloatArray(this.getAsArray())};CanvasMatrix4.prototype.makeIdentity=function(){this.m11=1;this.m12=0;this.m13=0;this.m14=0;this.m21=0;this.m22=1;this.m23=0;this.m24=0;this.m31=0;this.m32=0;this.m33=1;this.m34=0;this.m41=0;this.m42=0;this.m43=0;this.m44=1};CanvasMatrix4.prototype.transpose=function(){var a=this.m12;this.m12=this.m21;this.m21=a;a=this.m13;this.m13=this.m31;this.m31=a;a=this.m14;this.m14=this.m41;this.m41=a;a=this.m23;this.m23=this.m32;this.m32=a;a=this.m24;this.m24=this.m42;this.m42=a;a=this.m34;this.m34=this.m43;this.m43=a};CanvasMatrix4.prototype.invert=function(){var a=this._determinant4x4();if(Math.abs(a)<1e-8){return null}this._makeAdjoint();this.m11/=a;this.m12/=a;this.m13/=a;this.m14/=a;this.m21/=a;this.m22/=a;this.m23/=a;this.m24/=a;this.m31/=a;this.m32/=a;this.m33/=a;this.m34/=a;this.m41/=a;this.m42/=a;this.m43/=a;this.m44/=a};CanvasMatrix4.prototype.translate=function(a,d,c){if(a==undefined){a=0}if(d==undefined){d=0}if(c==undefined){c=0}var b=new CanvasMatrix4();b.m41=a;b.m42=d;b.m43=c;this.multRight(b)};CanvasMatrix4.prototype.scale=function(a,d,c){if(a==undefined){a=1}if(c==undefined){if(d==undefined){d=a;c=a}else{c=1}}else{if(d==undefined){d=a}}var b=new CanvasMatrix4();b.m11=a;b.m22=d;b.m33=c;this.multRight(b)};CanvasMatrix4.prototype.rotate=function(c,k,h,f){c=c/180*Math.PI;c/=2;var i=Math.sin(c);var e=Math.cos(c);var j=i*i;var b=Math.sqrt(k*k+h*h+f*f);if(b==0){k=0;h=0;f=1}else{if(b!=1){k/=b;h/=b;f/=b}}var l=new CanvasMatrix4();if(k==1&&h==0&&f==0){l.m11=1;l.m12=0;l.m13=0;l.m21=0;l.m22=1-2*j;l.m23=2*i*e;l.m31=0;l.m32=-2*i*e;l.m33=1-2*j;l.m14=l.m24=l.m34=0;l.m41=l.m42=l.m43=0;l.m44=1}else{if(k==0&&h==1&&f==0){l.m11=1-2*j;l.m12=0;l.m13=-2*i*e;l.m21=0;l.m22=1;l.m23=0;l.m31=2*i*e;l.m32=0;l.m33=1-2*j;l.m14=l.m24=l.m34=0;l.m41=l.m42=l.m43=0;l.m44=1}else{if(k==0&&h==0&&f==1){l.m11=1-2*j;l.m12=2*i*e;l.m13=0;l.m21=-2*i*e;l.m22=1-2*j;l.m23=0;l.m31=0;l.m32=0;l.m33=1;l.m14=l.m24=l.m34=0;l.m41=l.m42=l.m43=0;l.m44=1}else{var a=k*k;var g=h*h;var d=f*f;l.m11=1-2*(g+d)*j;l.m12=2*(k*h*j+f*i*e);l.m13=2*(k*f*j-h*i*e);l.m21=2*(h*k*j-f*i*e);l.m22=1-2*(d+a)*j;l.m23=2*(h*f*j+k*i*e);l.m31=2*(f*k*j+h*i*e);l.m32=2*(f*h*j-k*i*e);l.m33=1-2*(a+g)*j;l.m14=l.m24=l.m34=0;l.m41=l.m42=l.m43=0;l.m44=1}}}this.multRight(l)};CanvasMatrix4.prototype.multRight=function(q){var l=(this.m11*q.m11+this.m12*q.m21+this.m13*q.m31+this.m14*q.m41);var k=(this.m11*q.m12+this.m12*q.m22+this.m13*q.m32+this.m14*q.m42);var i=(this.m11*q.m13+this.m12*q.m23+this.m13*q.m33+this.m14*q.m43);var g=(this.m11*q.m14+this.m12*q.m24+this.m13*q.m34+this.m14*q.m44);var d=(this.m21*q.m11+this.m22*q.m21+this.m23*q.m31+this.m24*q.m41);var c=(this.m21*q.m12+this.m22*q.m22+this.m23*q.m32+this.m24*q.m42);var b=(this.m21*q.m13+this.m22*q.m23+this.m23*q.m33+this.m24*q.m43);var a=(this.m21*q.m14+this.m22*q.m24+this.m23*q.m34+this.m24*q.m44);var p=(this.m31*q.m11+this.m32*q.m21+this.m33*q.m31+this.m34*q.m41);var o=(this.m31*q.m12+this.m32*q.m22+this.m33*q.m32+this.m34*q.m42);var n=(this.m31*q.m13+this.m32*q.m23+this.m33*q.m33+this.m34*q.m43);var m=(this.m31*q.m14+this.m32*q.m24+this.m33*q.m34+this.m34*q.m44);var j=(this.m41*q.m11+this.m42*q.m21+this.m43*q.m31+this.m44*q.m41);var h=(this.m41*q.m12+this.m42*q.m22+this.m43*q.m32+this.m44*q.m42);var f=(this.m41*q.m13+this.m42*q.m23+this.m43*q.m33+this.m44*q.m43);var e=(this.m41*q.m14+this.m42*q.m24+this.m43*q.m34+this.m44*q.m44);this.m11=l;this.m12=k;this.m13=i;this.m14=g;this.m21=d;this.m22=c;this.m23=b;this.m24=a;this.m31=p;this.m32=o;this.m33=n;this.m34=m;this.m41=j;this.m42=h;this.m43=f;this.m44=e};CanvasMatrix4.prototype.multLeft=function(q){var l=(q.m11*this.m11+q.m12*this.m21+q.m13*this.m31+q.m14*this.m41);var k=(q.m11*this.m12+q.m12*this.m22+q.m13*this.m32+q.m14*this.m42);var i=(q.m11*this.m13+q.m12*this.m23+q.m13*this.m33+q.m14*this.m43);var g=(q.m11*this.m14+q.m12*this.m24+q.m13*this.m34+q.m14*this.m44);var d=(q.m21*this.m11+q.m22*this.m21+q.m23*this.m31+q.m24*this.m41);var c=(q.m21*this.m12+q.m22*this.m22+q.m23*this.m32+q.m24*this.m42);var b=(q.m21*this.m13+q.m22*this.m23+q.m23*this.m33+q.m24*this.m43);var a=(q.m21*this.m14+q.m22*this.m24+q.m23*this.m34+q.m24*this.m44);var p=(q.m31*this.m11+q.m32*this.m21+q.m33*this.m31+q.m34*this.m41);var o=(q.m31*this.m12+q.m32*this.m22+q.m33*this.m32+q.m34*this.m42);var n=(q.m31*this.m13+q.m32*this.m23+q.m33*this.m33+q.m34*this.m43);var m=(q.m31*this.m14+q.m32*this.m24+q.m33*this.m34+q.m34*this.m44);var j=(q.m41*this.m11+q.m42*this.m21+q.m43*this.m31+q.m44*this.m41);var h=(q.m41*this.m12+q.m42*this.m22+q.m43*this.m32+q.m44*this.m42);var f=(q.m41*this.m13+q.m42*this.m23+q.m43*this.m33+q.m44*this.m43);var e=(q.m41*this.m14+q.m42*this.m24+q.m43*this.m34+q.m44*this.m44);this.m11=l;this.m12=k;this.m13=i;this.m14=g;this.m21=d;this.m22=c;this.m23=b;this.m24=a;this.m31=p;this.m32=o;this.m33=n;this.m34=m;this.m41=j;this.m42=h;this.m43=f;this.m44=e};CanvasMatrix4.prototype.ortho=function(b,j,a,h,g,f){var e=(b+j)/(b-j);var d=(h+a)/(h-a);var c=(f+g)/(f-g);var i=new CanvasMatrix4();i.m11=2/(b-j);i.m12=0;i.m13=0;i.m14=0;i.m21=0;i.m22=2/(h-a);i.m23=0;i.m24=0;i.m31=0;i.m32=0;i.m33=-2/(f-g);i.m34=0;i.m41=e;i.m42=d;i.m43=c;i.m44=1;this.multRight(i)};CanvasMatrix4.prototype.frustum=function(f,k,b,i,h,g){var j=new CanvasMatrix4();var e=(k+f)/(k-f);var d=(i+b)/(i-b);var c=-(g+h)/(g-h);var a=-(2*g*h)/(g-h);j.m11=(2*h)/(k-f);j.m12=0;j.m13=0;j.m14=0;j.m21=0;j.m22=2*h/(i-b);j.m23=0;j.m24=0;j.m31=e;j.m32=d;j.m33=c;j.m34=-1;j.m41=0;j.m42=0;j.m43=a;j.m44=0;this.multRight(j)};CanvasMatrix4.prototype.perspective=function(c,b,h,e){var g=Math.tan(c*Math.PI/360)*h;var a=-g;var f=b*a;var d=b*g;this.frustum(f,d,a,g,h,e)};CanvasMatrix4.prototype.lookat=function(k,i,h,q,p,o,d,b,a){var n=new CanvasMatrix4();var f=k-q;var e=i-p;var c=h-o;var g=Math.sqrt(f*f+e*e+c*c);if(g){f/=g;e/=g;c/=g}var m=d;var l=b;var j=a;xx=l*c-j*e;xy=-m*c+j*f;xz=m*e-l*f;m=e*xz-c*xy;l=-f*xz+c*xx;m=f*xy-e*xx;g=Math.sqrt(xx*xx+xy*xy+xz*xz);if(g){xx/=g;xy/=g;xz/=g}g=Math.sqrt(m*m+l*l+j*j);if(g){m/=g;l/=g;j/=g}n.m11=xx;n.m12=xy;n.m13=xz;n.m14=0;n.m21=m;n.m22=l;n.m23=j;n.m24=0;n.m31=f;n.m32=e;n.m33=c;n.m34=0;n.m41=0;n.m42=0;n.m43=0;n.m44=1;n.translate(-k,-i,-h);this.multRight(n)};CanvasMatrix4.prototype._determinant2x2=function(f,e,h,g){return f*g-e*h};CanvasMatrix4.prototype._determinant3x3=function(c,b,a,i,h,g,f,e,d){return c*this._determinant2x2(h,g,e,d)-i*this._determinant2x2(b,a,e,d)+f*this._determinant2x2(b,a,h,g)};CanvasMatrix4.prototype._determinant4x4=function(){var e=this.m11;var m=this.m12;var i=this.m13;var c=this.m14;var d=this.m21;var l=this.m22;var h=this.m23;var b=this.m24;var a=this.m31;var k=this.m32;var g=this.m33;var p=this.m34;var o=this.m41;var j=this.m42;var f=this.m43;var n=this.m44;return e*this._determinant3x3(l,k,j,h,g,f,b,p,n)-m*this._determinant3x3(d,a,o,h,g,f,b,p,n)+i*this._determinant3x3(d,a,o,l,k,j,b,p,n)-c*this._determinant3x3(d,a,o,l,k,j,h,g,f)};CanvasMatrix4.prototype._makeAdjoint=function(){var e=this.m11;var m=this.m12;var i=this.m13;var c=this.m14;var d=this.m21;var l=this.m22;var h=this.m23;var b=this.m24;var a=this.m31;var k=this.m32;var g=this.m33;var p=this.m34;var o=this.m41;var j=this.m42;var f=this.m43;var n=this.m44;this.m11=this._determinant3x3(l,k,j,h,g,f,b,p,n);this.m21=-this._determinant3x3(d,a,o,h,g,f,b,p,n);this.m31=this._determinant3x3(d,a,o,l,k,j,b,p,n);this.m41=-this._determinant3x3(d,a,o,l,k,j,h,g,f);this.m12=-this._determinant3x3(m,k,j,i,g,f,c,p,n);this.m22=this._determinant3x3(e,a,o,i,g,f,c,p,n);this.m32=-this._determinant3x3(e,a,o,m,k,j,c,p,n);this.m42=this._determinant3x3(e,a,o,m,k,j,i,g,f);this.m13=this._determinant3x3(m,l,j,i,h,f,c,b,n);this.m23=-this._determinant3x3(e,d,o,i,h,f,c,b,n);this.m33=this._determinant3x3(e,d,o,m,l,j,c,b,n);this.m43=-this._determinant3x3(e,d,o,m,l,j,i,h,f);this.m14=-this._determinant3x3(m,l,k,i,h,g,c,b,p);this.m24=this._determinant3x3(e,d,a,i,h,g,c,b,p);this.m34=-this._determinant3x3(e,d,a,m,l,k,c,b,p);this.m44=this._determinant3x3(e,d,a,m,l,k,i,h,g)};